<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matematika ‚Äî P≈ô√≠klady</title>
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: #000000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: #e5e7eb;
    }
    .menu-fab {
      position: fixed;
      top: 8px;
      left: 8px;
      color: #cbd5e1;
      text-decoration: none;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(0,0,0,0.35);
      border: 1px solid #ffffff;
      z-index: 10000;
    }
    .menu-fab:hover { color: #ffffff; text-decoration: underline; }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: center;
      gap: 10px 16px;
      padding: 12px 16px;
      width: min(92vw, 1000px);
      margin: 0 auto;
    }
    .controls .group {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .seg {
      display: inline-flex;
      border: 1px solid #ffffff;
      border-radius: 10px;
      overflow: hidden;
    }
    .seg button {
      appearance: none;
      background: transparent;
      color: #ffd400;
      border: 0;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
    }
    .seg button.active {
      background: rgba(255, 212, 0, 0.12);
      color: #ffffff;
    }
    .range {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #cbd5e1;
    }
    input[type="range"] {
      width: 200px;
    }
    .box {
      width: 90vw;
      height: 78vh;
      margin: 0 auto;
      background: #000000;
      border: 1px solid #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(16,24,40,0.20);
      position: relative;
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .problem {
      text-align: center;
      display: grid;
      gap: 18px;
      align-items: center;
      justify-items: center;
    }
    .expr {
      font-size: clamp(48px, 10vw, 96px);
      line-height: 1.1;
      letter-spacing: 1px;
      color: #ffd400;
    }
    .answer {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .answer-display {
      display: none;
      width: min(50vw, 320px);
      padding: 16px 18px;
      font-size: clamp(24px, 5vw, 40px);
      text-align: center;
      border-radius: 12px;
      border: 1px solid #c9ced6;
      background: #0b0b0b;
      color: #ffffff;
      min-height: 56px;
    }
    .answer input[type="number"] {
      width: min(50vw, 320px);
      padding: 16px 18px;
      font-size: clamp(24px, 5vw, 40px);
      text-align: center;
      border-radius: 12px;
      border: 1px solid #c9ced6;
      outline: none;
      background: #0b0b0b;
      color: #ffffff;
    }
    .answer input[type="number"]:focus {
      border-color: #ffd400;
      box-shadow: 0 0 0 3px rgba(255, 212, 0, 0.2);
    }
    .buttons {
      display: flex;
      gap: 10px;
    }
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 56px);
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }
    .numpad button {
      appearance: none;
      background: rgba(255, 212, 0, 0.08);
      color: #ffd400;
      border: 1px solid #ffd400;
      border-radius: 10px;
      padding: 10px 0;
      font-size: 18px;
      cursor: pointer;
    }
    .numpad button.action {
      color: #e5e7eb;
      border-color: #e5e7eb;
    }
    .numpad .wide {
      grid-column: span 3;
    }
    .btn {
      appearance: none;
      background: rgba(255, 212, 0, 0.12);
      color: #ffd400;
      border: 1px solid #ffd400;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn:hover, .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 212, 0, 0.2);
    }
    .score {
      display: flex;
      gap: 14px;
      font-size: 14px;
      color: #cbd5e1;
      justify-content: center;
      margin-top: 6px;
    }
    .msg {
      min-height: 24px;
      font-size: 16px;
      color: #cbd5e1;
      text-align: center;
      margin-top: 6px;
    }
    .ok { color: #22c55e; }
    .bad { color: #ef4444; }
    .shake { animation: shake .35s ease; }
    @keyframes shake {
      10%, 90% { transform: translateX(-2px); }
      20%, 80% { transform: translateX(4px); }
      30%, 50%, 70% { transform: translateX(-8px); }
      40%, 60% { transform: translateX(8px); }
    }
    canvas.confetti {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .menu-link {
      color: #cbd5e1;
      text-decoration: none;
      font-size: 14px;
      margin-left: 6px;
    }
    .menu-link:hover { color: #ffffff; text-decoration: underline; }
    /* mobile tweaks */
    @media (max-width: 640px) {
      .box {
        width: 94vw;
        height: 70vh;
      }
      .controls {
        grid-template-columns: 1fr;
        gap: 8px 12px;
      }
      .expr { font-size: clamp(36px, 12vw, 72px); }
      .answer {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        gap: 12px;
      }
      .answer input[type="number"] {
        width: 100%;
        max-width: none;
      }
      /* hide real input on mobile and show display-only readout */
      .answer input[type="number"] { display: none; }
      .answer-display { display: block; width: 100%; }
      .buttons { justify-content: center; }
      .numpad {
        width: 100%;
        max-width: 380px;
        grid-template-columns: repeat(3, 1fr);
      }
      .numpad button { padding: 14px 0; font-size: 20px; }
    }
    /* touch improvements */
    button, .btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    input { touch-action: manipulation; }
  </style>
  </head>
  <body>
    <a class="menu-fab" href="index.html">‚Üê Menu</a>
    <div class="controls">
      <div class="group">
        <span>Re≈æim:</span>
        <div class="seg" role="tablist" aria-label="V√Ωbƒõr operace">
          <button class="active" data-op="plus" aria-selected="true">+</button>
          <button data-op="minus">‚àí</button>
          <button data-op="times">√ó</button>
          <button data-op="divide">√∑</button>
          <button data-op="mix">Mix</button>
        </div>
      </div>
      <div class="group range">
        <label for="max">Rozsah: <span id="rangeLabel">‚â§ 20</span></label>
        <input id="max" type="range" min="5" max="100" step="5" value="20" />
      </div>
    </div>
    <div class="box">
      <div class="problem" id="problem">
        <div class="expr" id="expr">0 + 0 = ?</div>
        <div class="answer">
          <input id="answer" type="number" inputmode="numeric" placeholder="v√Ωsledek" />
          <div id="answerDisplay" class="answer-display"></div>
          <div class="buttons">
            <button class="btn" id="skipBtn">P≈ôeskoƒçit (Esc)</button>
          </div>
          <div class="numpad" aria-label="ƒå√≠seln√° kl√°vesnice">
            <button data-key="7">7</button>
            <button data-key="8">8</button>
            <button data-key="9">9</button>
            <button data-key="4">4</button>
            <button data-key="5">5</button>
            <button data-key="6">6</button>
            <button data-key="1">1</button>
            <button data-key="2">2</button>
            <button data-key="3">3</button>
            <button class="action" data-key="C">C</button>
            <button data-key="0">0</button>
            <button class="action" data-key="BACK">‚å´</button>
            <button class="action wide" data-key="ENTER">‚úì Zkontrolovat</button>
          </div>
        </div>
        <div class="msg" id="msg"></div>
        <div class="score" id="score">
          <span>Spr√°vnƒõ: <strong id="ok">0</strong></span>
          <span>Pokusy: <strong id="attempts">0</strong></span>
          <span>S√©rie: <strong id="streak">0</strong></span>
        </div>
      </div>
      <canvas class="confetti" id="confetti"></canvas>
    </div>
    <script>
      (function () {
        const exprEl = document.getElementById('expr');
        const answerEl = document.getElementById('answer');
        const answerDisplay = document.getElementById('answerDisplay') || (function(){ const d=document.createElement('div'); d.id='answerDisplay'; d.className='answer-display'; answerEl.parentElement.insertBefore(d, answerEl.nextSibling); return d; })();
        const msgEl = document.getElementById('msg');
        const okEl = document.getElementById('ok');
        const attemptsEl = document.getElementById('attempts');
        const streakEl = document.getElementById('streak');
        const maxEl = document.getElementById('max');
        const rangeLabel = document.getElementById('rangeLabel');
        const skipBtn = document.getElementById('skipBtn');
        const confettiCanvas = document.getElementById('confetti');
        const seg = document.querySelectorAll('.seg button');
        const numpad = document.querySelector('.numpad');

        let mode = 'plus';
        let maxVal = Number(maxEl.value) || 20;
        let current = null;
        let lastKey = '';
        function problemKey(p) {
          if (!p) return '';
          if (p.sym === '+' || p.sym === '√ó') {
            const x = Math.min(p.a, p.b);
            const y = Math.max(p.a, p.b);
            return p.sym + ':' + x + ',' + y;
          }
          return p.sym + ':' + p.a + ',' + p.b;
        }
        let ok = 0;
        let attempts = 0;
        let streak = 0;
        let answerStr = '';
        const isMobile = () => window.matchMedia('(max-width: 640px)').matches;
        function setAnswer(v) {
          answerStr = String(v || '');
          if (answerEl) answerEl.value = answerStr;
          if (answerDisplay) answerDisplay.textContent = answerStr || '';
        }

        function randInt(min, max) {
          return Math.floor(rand() * (max - min + 1)) + min;
        }
        // Seeded RNG for reproducibility in a session
        const sessionSeed = (() => {
          try {
            const arr = new Uint32Array(1);
            (crypto || window.crypto).getRandomValues(arr);
            return arr[0] >>> 0;
          } catch (_) {
            return ((Date.now() ^ Math.floor(Math.random() * 0xffffffff)) >>> 0);
          }
        })();
        function mulberry32(seed) {
          let a = seed >>> 0;
          return function () {
            a |= 0; a = (a + 0x6D2B79F5) | 0;
            let t = Math.imul(a ^ (a >>> 15), 1 | a);
            t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
          };
        }
        const rand = mulberry32(sessionSeed);
        function chance(p) { return rand() < p; }
        function shuffle(arr) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(rand() * (i + 1));
            const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
          }
          return arr;
        }
        function pickNonTrivial(min, max, avoidList) {
          if (max < min) return min;
          const avoid = new Set(avoidList || []);
          for (let i = 0; i < 24; i++) {
            const x = randInt(min, max);
            if (!avoid.has(x)) return x;
          }
          return randInt(min, max);
        }
        function factorPairsWithin(n, limit) {
          const pairs = [];
          const up = Math.min(n, limit);
          for (let d = 1; d <= up; d++) {
            if (n % d !== 0) continue;
            const e = n / d;
            if (e <= limit) pairs.push([d, e]);
          }
          return pairs;
        }
        const WEIGHTS = {
          mul: { pZero: 0.02, pOne: 0.08 },
          div: { pQuotient1: 0.05, pDivideBy1: 0.02 }
        };
        let mulCore = [], mulIdx = 0;
        let divCore = [], divIdx = 0;
        function buildMulCore(N) {
          const pairs = [];
          for (let a = 2; a <= N; a++) {
            for (let b = a; b <= N; b++) {
              if (a * b <= N) pairs.push([a, b]);
            }
          }
          shuffle(pairs);
          mulCore = pairs; mulIdx = 0;
        }
        function buildDivCore(N) {
          const pairs = [];
          for (let d = 2; d <= N; d++) {
            const qMax = Math.floor(N / d);
            for (let q = 2; q <= qMax; q++) pairs.push([d * q, d]);
          }
          shuffle(pairs);
          divCore = pairs; divIdx = 0;
        }
        function rebuildCores() { buildMulCore(maxVal); buildDivCore(maxVal); }

        function pickOp() {
          if (mode !== 'mix') return mode;
          const ops = ['plus', 'minus', 'times', 'divide'];
          return ops[randInt(0, ops.length - 1)];
        }

        function makeProblem() {
          const op = pickOp();
          let a = 0, b = 0, sym = '+', ans = 0;
          if (op === 'plus') {
            a = randInt(0, maxVal);
            b = randInt(0, Math.max(0, maxVal - a));
            ans = a + b; sym = '+';
          } else if (op === 'minus') {
            a = randInt(0, maxVal);
            b = randInt(0, a); // nez√°porn√Ω v√Ωsledek
            ans = a - b; sym = '‚àí';
          } else if (op === 'times') {
            sym = '√ó';
            if (maxVal <= 1) {
              a = randInt(0, maxVal);
              b = randInt(0, maxVal);
              ans = a * b;
            } else {
              const pZero = WEIGHTS.mul.pZero;
              const pOne  = WEIGHTS.mul.pOne;
              const r = rand();
              if (r < pZero) {
                const swap = chance(0.5);
                const nonTriv = maxVal >= 2 ? pickNonTrivial(2, maxVal, []) : randInt(0, maxVal);
                a = swap ? 0 : nonTriv;
                b = swap ? nonTriv : 0;
                ans = a * b;
              } else if (r < pZero + pOne) {
                const swap = chance(0.5);
                const nonTriv = maxVal >= 2 ? pickNonTrivial(2, maxVal, []) : 1;
                a = swap ? 1 : nonTriv;
                b = swap ? nonTriv : 1;
                ans = a * b;
              } else {
                if (mulCore.length === 0) buildMulCore(maxVal);
                if (mulCore.length > 0) {
                  const pair = mulCore[(mulIdx++) % mulCore.length];
                  a = pair[0]; b = pair[1];
                  if (chance(0.5)) { const t = a; a = b; b = t; }
                  ans = a * b; // guaranteed <= maxVal
                } else {
                  // Fallback: choose product 1..N and factor
                  const prod = randInt(1, maxVal);
                  const pairs = factorPairsWithin(prod, maxVal);
                  const nonTrivial = pairs.filter(([x, y]) => x >= 2 && y >= 2);
                  const pick = (arr) => arr[randInt(0, arr.length - 1)];
                  let sel = (nonTrivial.length ? pick(nonTrivial) : pick(pairs));
                  if (chance(0.5)) sel = [sel[1], sel[0]];
                  a = sel[0]; b = sel[1]; ans = prod;
                }
              }
            }
          } else if (op === 'divide') {
            sym = '√∑';
            if (maxVal === 0) {
              a = 0; b = 1; ans = 0;
            } else {
              const pQ1 = WEIGHTS.div.pQuotient1;
              const pD1 = WEIGHTS.div.pDivideBy1;
              const r = rand();
              if (r < pQ1 && maxVal >= 2) {
                // q = 1 => n = d
                b = randInt(2, maxVal);
                a = b; ans = 1;
              } else if (r < pQ1 + pD1 && maxVal >= 2) {
                // divide by 1
                a = randInt(2, maxVal);
                b = 1; ans = a;
              } else {
                if (divCore.length === 0) buildDivCore(maxVal);
                const pair = divCore[(divIdx++) % divCore.length];
                a = pair[0]; b = pair[1]; ans = Math.floor(a / b);
              }
            }
          }
          return { a, b, sym, ans };
        }

        function renderProblem(p) {
          exprEl.textContent = p.a + ' ' + p.sym + ' ' + p.b + ' = ?';
        }

        function updateScore() {
          okEl.textContent = String(ok);
          attemptsEl.textContent = String(attempts);
          streakEl.textContent = String(streak);
        }

        function setMessage(text, cls) {
          msgEl.textContent = text || '';
          msgEl.className = 'msg' + (cls ? ' ' + cls : '');
        }

        function shake() {
          exprEl.classList.remove('shake');
          // reflow
          void exprEl.offsetWidth;
          exprEl.classList.add('shake');
        }

        // simple star confetti burst
        function burstConfetti() {
          const ctx = confettiCanvas.getContext('2d');
          const dpr = window.devicePixelRatio || 1;
          const rect = confettiCanvas.getBoundingClientRect();
          const w = Math.floor(rect.width * dpr);
          const h = Math.floor(rect.height * dpr);
          if (confettiCanvas.width !== w || confettiCanvas.height !== h) {
            confettiCanvas.width = w; confettiCanvas.height = h;
          }
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          const N = 80;
          const stars = new Array(N).fill(0).map(() => ({
            x: Math.random() * w,
            y: Math.random() * (h * 0.5),
            vx: (Math.random() - 0.5) * 2,
            vy: Math.random() * 1.5 + 0.5,
            rot: Math.random() * Math.PI * 2,
            vr: (Math.random() - 0.5) * 0.2,
            r: Math.random() * 4 + 2
          }));
          const start = performance.now();
          function drawStar(cx, cy, r, rot) {
            const ri = r * 0.5;
            let a = -Math.PI / 2 + rot;
            const step = Math.PI / 5;
            ctx.beginPath();
            ctx.moveTo(cx + Math.cos(a) * r, cy + Math.sin(a) * r);
            for (let k = 0; k < 5; k++) {
              a += step; ctx.lineTo(cx + Math.cos(a) * ri, cy + Math.sin(a) * ri);
              a += step; ctx.lineTo(cx + Math.cos(a) * r, cy + Math.sin(a) * r);
            }
            ctx.fill();
          }
          (function frame(t) {
            const dt = Math.min(32, t - start) / 16;
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#ffd400';
            for (const s of stars) {
              s.x += s.vx * dpr;
              s.y += s.vy * dpr;
              s.vy += 0.02 * dpr;
              s.rot += s.vr;
              drawStar(s.x, s.y, s.r * dpr, s.rot);
            }
            if (t - start < 900) {
              requestAnimationFrame(frame);
            } else {
              ctx.clearRect(0, 0, w, h);
            }
          })(start);
        }

        function nextProblem() {
          let tries = 0;
          let p;
          do {
            p = makeProblem();
            tries++;
          } while (problemKey(p) === lastKey && tries < 50);
          current = p;
          lastKey = problemKey(p);
          renderProblem(current);
          setAnswer('');
          setMessage('');
          if (!isMobile()) answerEl.focus();
        }

        function check() {
          attempts++;
          const val = Number(answerStr);
          if (Number.isFinite(val) && val === current.ans) {
            ok++; streak++;
            updateScore();
            setMessage('Spr√°vnƒõ! üéâ', 'ok');
            burstConfetti();
            setTimeout(nextProblem, 600);
          } else {
            streak = 0;
            updateScore();
            setMessage('Zkus to znovu.', 'bad');
            shake();
          }
        }

        // UI events
        seg.forEach(btn => {
          btn.addEventListener('click', () => {
            seg.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mode = btn.getAttribute('data-op');
            nextProblem();
          });
        });
        maxEl.addEventListener('input', () => {
          maxVal = Number(maxEl.value) || 20;
          rangeLabel.textContent = '‚â§ ' + maxVal;
          rebuildCores();
          nextProblem();
        });
        skipBtn.addEventListener('click', nextProblem);
        if (numpad) {
          numpad.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const key = btn.getAttribute('data-key');
            if (key === 'C') {
              setAnswer('');
              if (!isMobile()) answerEl.focus();
            } else if (key === 'BACK') {
              setAnswer(answerStr.slice(0, -1));
              if (!isMobile()) answerEl.focus();
            } else if (key === 'ENTER') {
              check();
            } else if (/^[0-9]$/.test(key)) {
              setAnswer((answerStr || '') + key);
              if (!isMobile()) answerEl.focus();
            }
          });
        }
        if (answerEl) {
          answerEl.addEventListener('input', () => setAnswer(answerEl.value));
        }
        answerEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            check();
          } else if (e.key === 'Escape') {
            nextProblem();
          }
        });
        window.addEventListener('keydown', (e) => {
          if (document.activeElement !== answerEl) {
            if (e.key === 'Enter') check();
            if (e.key === 'Escape') nextProblem();
          }
        });

        // init
        rangeLabel.textContent = '‚â§ ' + maxVal;
        rebuildCores();
        updateScore();
        nextProblem();
      })();
    </script>
  </body>
  </html>


